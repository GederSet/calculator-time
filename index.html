<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–¢—Ä–µ–∫–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/easymde/dist/easymde.min.css"
    />
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        --bg-main: #ececf1;
        --container-bg: #fff;
        --calculate-bg: #ececf1;
        --calculate-bg-hover: #e0e0e6;
        --text-main: #343541;
        --subtext: #6e6e80;
        --input-bg: #fff;
        --project-border: #d9d9e3;
        --primary: #10a37f;
        --primary-hover: #0d8a6a;
        --danger: #ff4d4f;
        --danger-hover: #d9363e;
        --input-border: #f7f7fa;
        --bubble-bg: #f7f7fa;
        --shadow: 0 4px 32px rgb(35 35 35 / 10%);
      }
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: var(--bg-main);
        color: var(--text-main);
        min-height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 400;
      }
      .container {
        width: 100%;
        max-width: 540px;
        margin: 40px auto 40px auto;
        background: var(--container-bg);
        border-radius: 16px;
        padding: 0 0 16px 0;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }
      .title {
        margin: 0;
        padding: 32px 32px 0 32px;
        margin-bottom: 20px;
        font-size: 2rem;
        color: var(--text-main);
        letter-spacing: -1px;
      }
      .sub-title {
        color: var(--text-main);
        font-size: 18px;
        margin-bottom: 10px;
      }
      form {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0 32px;
      }
      .form-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }
      .project-input {
        padding: 10px;
      }
      .form-row input,
      .form-row textarea {
        padding: 10px 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-main);
        transition: background 0.2s, border 0.2s;
      }
      .form-row input:focus,
      .form-row textarea:focus,
      .project-fields input:focus,
      .project-fields textarea:focus {
        border: 1.5px solid var(--primary);
        outline: none;
        background: #fff;
      }
      .projects-list {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-bottom: 10px;
      }
      .project {
        background: var(--bubble-bg);
        border: 1px solid var(--input-border);
        border-radius: 16px;
        padding: 16px 18px 20px 18px;
        margin-bottom: 20px;
        position: relative;
      }
      .project-fields label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        font-weight: 500;
        color: var(--subtext);
        margin-bottom: 2px;
      }
      .project-label {
        font-size: 18px;
        font-weight: 400;
        color: var(--text-main);
        margin-bottom: 10px;
      }
      .project-fields input {
        padding: 12px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-main);
        margin-bottom: 2px;
        transition: border 0.2s;
      }
      .project textarea {
        outline: none;
        min-height: 60px;
        resize: vertical;
        padding: 12px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-main);
        margin-bottom: 10px;
        transition: border 0.2s;
      }
      .remove-project-btn {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 0;
        margin-bottom: 0;
        text-align: right;
        transition: background 0.2s;
      }
      .remove-project-btn:hover {
        background: var(--danger-hover);
      }
      .add-project-btn,
      .calculate-btn,
      .send-btn {
        width: 100%;
        min-width: 120px;
        padding: 10px 18px;
        font-size: 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        transition: background 0.2s, color 0.2s;
      }
      .add-project-btn {
        background: var(--primary);
        color: #fff;
      }
      .add-project-btn:hover {
        background: var(--primary-hover);
      }
      .calculate-btn {
        background: var(--calculate-bg);
        color: var(--text-main);
        border: 1px solid var(--input-border);
      }
      .calculate-btn:hover {
        background: var(--calculate-bg-hover);
      }
      .send-btn {
        background: var(--primary);
        color: #fff;
      }
      .send-btn:hover {
        background: var(--primary-hover);
      }
      #result {
        margin: 16px 0 0 0;
        font-size: 18px;
        padding-top: 12px;
        color: var(--text-main);
        max-width: 80%;
        align-self: flex-start;
        margin-left: 0;
      }
      #statusMessage {
        margin-top: 15px;
        font-weight: 500;
        color: var(--primary);
        font-size: 15px;
        padding-left: 2px;
      }
      .editor-toolbar button {
        color: var(--text-main);
      }
      @media (max-width: 600px) {
        .container {
          max-width: 100vw;
          border-radius: 0;
          box-shadow: none;
        }
        form {
          padding: 0 8px;
        }
        h2 {
          padding: 24px 8px 0 8px;
        }
        #result {
          max-width: 98%;
        }
      }
      /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
      body.dark-theme {
        --bg-main: #181a20;
        --container-bg: #23262f;
        --calculate-bg: #23262f;
        --calculate-bg-hover: #17191f;
        --text-main: #f7f7fa;
        --subtext: #bdbdbd;
        --input-bg: #23262f;
        --input-border: #393b41;
        --primary: #10a37f;
        --primary-hover: #0d8a6a;
        --danger: #ff4d4f;
        --danger-hover: #d9363e;
        --input-border: #393b41;
        --bubble-bg: #23262f;
        --shadow: 0 4px 32px rgb(0 0 0 / 40%);
      }
      @media (prefers-color-scheme: dark) {
        body:not(.light-theme) {
          --bg-main: #181a20;
          --container-bg: #23262f;
          --calculate-bg: #23262f;
          --calculate-bg-hover: #17191f;
          --text-main: #f7f7fa;
          --subtext: #bdbdbd;
          --input-bg: #23262f;
          --input-border: #393b41;
          --primary: #10a37f;
          --primary-hover: #0d8a6a;
          --danger: #ff4d4f;
          --danger-hover: #d9363e;
          --input-border: #393b41;
          --bubble-bg: #23262f;
          --shadow: 0 4px 32px rgb(0 0 0 / 40%);
        }
      }
      body.dark-theme .form-row input,
      body.dark-theme .form-row textarea,
      body.dark-theme .project .project-fields input,
      body.dark-theme .project textarea {
        background: var(--input-bg);
      }
      body.dark-theme .form-row input:focus,
      body.dark-theme .form-row textarea:focus,
      body.dark-theme .project .project-fields input:focus,
      body.dark-theme .project textarea:focus {
        background: var(--container-bg);
      }
      body.dark-theme input[type='date'] {
        background: var(--input-bg);
      }
      body.dark-theme input[type='date']:focus {
        background: var(--container-bg);
      }
      .theme-toggle-btn {
        position: absolute;
        top: 18px;
        right: 24px;
        z-index: 10;
        background: none;
        border: none;
        color: var(--text-main);
        font-size: 22px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        transition: background 0.2s;
      }
      .theme-toggle-btn:hover {
        background: var(--input-bg);
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      function onTelegramAuth(user) {
        alert(
          'Logged in as ' +
            user.first_name +
            ' ' +
            user.last_name +
            ' (' +
            user.id +
            (user.username ? ', @' + user.username : '') +
            ')'
        )
      }
      // –¢–µ–º–∞: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      function setTheme(theme) {
        document.body.classList.remove('dark-theme', 'light-theme')
        if (theme === 'dark') {
          document.body.classList.add('dark-theme')
        } else if (theme === 'light') {
          document.body.classList.add('light-theme')
        }
        localStorage.setItem('theme', theme)
      }
      function toggleTheme() {
        const current = document.body.classList.contains('dark-theme')
          ? 'dark'
          : 'light'
        setTheme(current === 'dark' ? 'light' : 'dark')
        updateThemeIcon()
      }
      function updateThemeIcon() {
        const btn = document.getElementById('themeToggleBtn')
        if (document.body.classList.contains('dark-theme')) {
          btn.innerHTML = 'üåô'
        } else {
          btn.innerHTML = '‚òÄÔ∏è'
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
        const statusTelegram = document.getElementById('statusTelegram')
        if (statusTelegram && statusTelegram.textContent.includes('‚úÖ')) {
          statusTelegram.style.color = getSuccessColor()
        }
        const statusGoogle = document.getElementById('statusGoogle')
        if (statusGoogle && statusGoogle.textContent.includes('‚úÖ')) {
          statusGoogle.style.color = getSuccessColor()
        }
      }
      document.addEventListener('DOMContentLoaded', function () {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã
        const savedTheme = localStorage.getItem('theme')
        if (savedTheme) setTheme(savedTheme)
        else if (
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches
        )
          setTheme('dark')
        updateThemeIcon()
      })
    </script>
    <div class="container" style="position: relative">
      <button
        id="themeToggleBtn"
        class="theme-toggle-btn"
        type="button"
        onclick="toggleTheme()"
      >
        ‚òÄÔ∏è
      </button>
      <h2 class="title">–¢—Ä–µ–∫–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏</h2>
      <form id="timeForm" autocomplete="off" onsubmit="return false;">
        <div class="form-row">
          <label class="sub-title" for="userName">–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è:</label>
          <input type="text" id="userName" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" />
        </div>
        <div class="form-row">
          <label class="sub-title" for="workDate">–î–∞—Ç–∞:</label>
          <input type="date" id="workDate" required />
        </div>
        <div class="sub-title" style="margin-bottom: 10px; font-size: 18px">
          –ü—Ä–æ–µ–∫—Ç—ã:
        </div>
        <div id="projectsList" class="projects-list"></div>
        <button type="button" class="add-project-btn" onclick="addProject()">
          –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
        </button>
        <div style="margin-top: 20px; display: flex; gap: 10px">
          <button type="button" class="send-btn" onclick="sendData()">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
          <button
            type="button"
            class="calculate-btn"
            onclick="calculateTotalTime()"
          >
            –ü–æ—Å—á–∏—Ç–∞—Ç—å
          </button>
        </div>
        <div id="result"></div>
        <div id="statusMessage"></div>
      </form>
    </div>

    <script>
      let projects = []
      let projectId = 0

      function addProject() {
        const id = ++projectId
        projects.push({ id, name: '', time: '', comment: '' })
        renderProjects()
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
        updateTimePlaceholders()
      }
      window.addProject = addProject

      function removeProject(id) {
        if (confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç?')) {
          projects = projects.filter((p) => p.id !== id)
          renderProjects()
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
          updateTimePlaceholders()
        }
      }
      window.removeProject = removeProject

      function updateProjectField(id, field, value) {
        const proj = projects.find((p) => p.id === id)
        if (proj) {
          proj[field] = value
        }
      }
      window.updateProjectField = updateProjectField

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
      function calculateTotalUsedTime() {
        let totalMinutes = 0
        for (const proj of projects) {
          if (proj.time && proj.time.trim()) {
            const { hours, minutes } = parseTimeString(proj.time)
            totalMinutes += hours * 60 + minutes
          }
        }
        return totalMinutes
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
      function calculateRemainingTime() {
        const totalUsedMinutes = calculateTotalUsedTime()
        const workDayMinutes = 8 * 60 // 8 —á–∞—Å–æ–≤ –≤ –º–∏–Ω—É—Ç–∞—Ö
        const remainingMinutes = workDayMinutes - totalUsedMinutes
        return Math.max(0, remainingMinutes) // –ù–µ –º–µ–Ω—å—à–µ 0
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
      function formatTimeFromMinutes(minutes) {
        if (minutes <= 0) return '0—á 0–º'
        const hours = Math.floor(minutes / 60)
        const remainingMinutes = minutes % 60
        let result = ''
        if (hours > 0) result += hours + '—á '
        if (remainingMinutes > 0 || hours === 0)
          result += remainingMinutes + '–º'
        return result.trim()
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
      function updateTimePlaceholders() {
        const timeInputs = document.querySelectorAll(
          'input[name="project-time"]'
        )
        timeInputs.forEach((input, index) => {
          const currentProject = projects[index]
          if (currentProject) {
            // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentValue = currentProject.time

            // –í—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω—É–ª—è–µ–º –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è
            currentProject.time = ''
            const remainingTime = calculateRemainingTime()

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            currentProject.time = currentValue

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            input.placeholder = `${formatTimeFromMinutes(remainingTime)}`
          }
        })
      }

      function renderProjects() {
        const list = document.getElementById('projectsList')
        list.innerHTML = ''
        projects.forEach((proj) => {
          const div = document.createElement('div')
          div.className = 'project'
          div.innerHTML = `
            <div class="project-fields">
              <label>
                <p class="project-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</p>
                <input name="project-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" value="${proj.name.replace(
                  /"/g,
                  '&quot;'
                )}" onchange="updateProjectField(${
            proj.id
          }, 'name', this.value)" required />
              </label>
              <label>
                <p class="project-label">–í—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1—á 40–º)</p>
                <input name="project-time" type="text" placeholder="–í—Ä–µ–º—è" value="${proj.time.replace(
                  /"/g,
                  '&quot;'
                )}" oninput="updateProjectField(${
            proj.id
          }, 'time', this.value); updateTimePlaceholders()" required />
              </label>
              <label>
                <p class="project-label">–ß—Ç–æ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                <textarea placeholder="–ß—Ç–æ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ" onchange="updateProjectField(${
                  proj.id
                }, 'comment', this.value)">${proj.comment.replace(
            /</g,
            '&lt;'
          )}</textarea>
              </label>
            </div>
            <button type="button" class="remove-project-btn" onclick="removeProject(${
              proj.id
            })">–£–¥–∞–ª–∏—Ç—å</button>
          `
          list.appendChild(div)
        })
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        updateTimePlaceholders()
      }

      function calculateTotalTime() {
        let totalMinutes = 0
        let hasTime = false
        for (const proj of projects) {
          if (proj.time && proj.time.trim()) {
            const { hours, minutes } = parseTimeString(proj.time)
            totalMinutes += hours * 60 + minutes
            hasTime = true
          }
        }
        let finalHours = 0,
          finalMinutes = 0
        if (hasTime) {
          finalHours = Math.floor(totalMinutes / 60)
          finalMinutes = totalMinutes % 60
        }
        document.getElementById('result').textContent =
          '–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ' + finalHours + '—á ' + finalMinutes + '–º'
      }

      function sendData() {
        const name = document.getElementById('userName').value.trim()
        const date = document.getElementById('workDate').value
        if (!name || !date || projects.length === 0) {
          alert(
            '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–µ–∫—Ç.'
          )
          return
        }
        for (const proj of projects) {
          if (!proj.name || !proj.time || !proj.comment) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —É –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.')
            return
          }
        }
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
        const dateParts = date.split('-')
        const formattedDate =
          dateParts.length === 3 ? `${dateParts[2]}.${dateParts[1]}` : date
        let message = `${formattedDate} ${name.split(' ')[0]}`

        projects.forEach((proj) => {
          const { hours, minutes } = parseTimeString(proj.time)
          let timeStr = ''
          if (hours) timeStr += hours + '—á '
          if (minutes) timeStr += minutes + '–º'
          timeStr = timeStr.trim()
          message += `\n\n${timeStr} - ${proj.name}\n${proj.comment}`
        })

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        let statusTelegram = document.getElementById('statusTelegram')
        let statusGoogle = document.getElementById('statusGoogle')
        if (!statusTelegram) {
          statusTelegram = document.createElement('div')
          statusTelegram.id = 'statusTelegram'
          statusTelegram.style.marginTop = '15px'
          statusTelegram.style.fontWeight = '500'
          statusTelegram.style.fontSize = '15px'
          statusTelegram.style.display = 'flex'
          statusTelegram.style.alignItems = 'center'
          document
            .getElementById('statusMessage')
            .parentNode.insertBefore(
              statusTelegram,
              document.getElementById('statusMessage')
            )
        }
        if (!statusGoogle) {
          statusGoogle = document.createElement('div')
          statusGoogle.id = 'statusGoogle'
          statusGoogle.style.fontWeight = '500'
          statusGoogle.style.fontSize = '15px'
          statusGoogle.style.display = 'flex'
          statusGoogle.style.alignItems = 'center'
          document
            .getElementById('statusMessage')
            .parentNode.insertBefore(
              statusGoogle,
              document.getElementById('statusMessage')
            )
        }
        statusTelegram.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...'
        statusTelegram.style.color = 'orange'
        statusGoogle.textContent = ''
        fetch(
          'https://n8n-8018645861-7.nocodecloud.ru/webhook/send-to-telegram',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message }),
          }
        )
          .then((response) => {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram')
            return response.json()
          })
          .then(() => {
            statusTelegram.textContent = '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!'
            statusTelegram.style.color = getSuccessColor()

            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—è—Ç–Ω–∏—Ü–∞ –∏ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç—á–µ—Ç –∑–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å,
            // –º–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –∏ –æ—á–∏—â–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã, —á—Ç–æ–±—ã
            // –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –∑–∞—Ç—Ä–µ–∫–∞—Ç—å –ø—è—Ç–Ω–∏—Ü—É.
            if (isFridayToday()) {
              const dateInput = document.getElementById('workDate')
              const todayFormatted = getTodayDate()

              if (dateInput.value !== todayFormatted) {
                // –ü–µ—Ä–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ø—è—Ç–Ω–∏—Ü—É (–∑–∞ –≤—á–µ—Ä–∞) - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                saveFridayState()

                dateInput.value = todayFormatted
                projects = []
                addProject() // –û—á–∏—â–∞–µ—Ç –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
              } else {
                // –í—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ø—è—Ç–Ω–∏—Ü—É (–∑–∞ —Å–µ–≥–æ–¥–Ω—è) - –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                localStorage.removeItem('fridayState')
              }
            }
          })
          .catch(() => {
            statusTelegram.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram.'
            statusTelegram.style.color = 'red'
          })
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google –¢–∞–±–ª–∏—Ü—É (—á–µ—Ä–µ–∑ n8n webhook)
        statusGoogle.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google –¢–∞–±–ª–∏—Ü—É...'
        statusGoogle.style.color = 'orange'
        let googleErrors = 0
        let googleSent = 0
        projects.forEach((proj) => {
          const { hours, minutes } = parseTimeString(proj.time)
          let totalMinutes = hours * 60 + minutes
          if (!isFinite(totalMinutes) || totalMinutes <= 0) totalMinutes = ''
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ dd.mm.yyyy
          let formattedDate = date
          if (date && date.includes('-')) {
            const dateParts = date.split('-')
            if (dateParts.length === 3) {
              formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`
            }
          }
          const data = {
            employee: name,
            project: proj.name,
            date: formattedDate,
            time: totalMinutes ? String(totalMinutes) : '',
            comment: proj.comment,
          }
          fetch(
            'https://n8n-8018645861-7.nocodecloud.ru/webhook/timetracking',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            }
          )
            .then((response) => {
              if (!response.ok) googleErrors++
              else googleSent++
              if (googleSent + googleErrors === projects.length) {
                if (googleErrors === 0) {
                  statusGoogle.textContent =
                    '‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google –¢–∞–±–ª–∏—Ü—É!'
                  statusGoogle.style.color = getSuccessColor()
                } else {
                  statusGoogle.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Google –¢–∞–±–ª–∏—Ü—É (${googleErrors} –∏–∑ ${projects.length})`
                  statusGoogle.style.color = 'red'
                }
              }
            })
            .catch(() => {
              googleErrors++
              if (googleSent + googleErrors === projects.length) {
                statusGoogle.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Google –¢–∞–±–ª–∏—Ü—É (${googleErrors} –∏–∑ ${projects.length})`
                statusGoogle.style.color = 'red'
              }
            })
        })
      }

      function parseTimeString(timeStr) {
        let hours = 0,
          minutes = 0
        if (!timeStr) return { hours, minutes }
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1h 40m, 1—á 40–º, 30m, 2h, 1—á, 40–º
        const norm = timeStr
          .replace(/(\d+)\s*—á/gi, '$1h')
          .replace(/(\d+)\s*–º/gi, '$1m')
        const hourMatch = norm.match(/(\d+)\s*h/i)
        const minuteMatch = norm.match(/(\d+)\s*m/i)
        if (hourMatch) hours = parseInt(hourMatch[1], 10)
        if (minuteMatch) minutes = parseInt(minuteMatch[1], 10)
        return { hours, minutes }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ —É—Å–ø–µ—Ö–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã
      function getSuccessColor() {
        return document.body.classList.contains('dark-theme')
          ? 'rgb(18 188 18)'
          : 'green'
      }

      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏
      function saveUserNameToLocalStorage() {
        localStorage.setItem(
          'userName',
          document.getElementById('userName').value
        )
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—è—Ç–Ω–∏—Ü—ã
      function getTodayDate() {
        return new Date().toISOString().split('T')[0]
      }

      function isFridayToday() {
        const today = new Date()
        return today.getDay() === 5
      }

      function saveFridayState() {
        const state = {
          isFriday: true,
          date: getTodayDate(),
          timestamp: new Date().getTime(),
        }
        localStorage.setItem('fridayState', JSON.stringify(state))
      }

      function loadFridayState() {
        const saved = localStorage.getItem('fridayState')
        if (!saved) return null

        try {
          const state = JSON.parse(saved)
          const today = new Date()
          const savedDate = new Date(state.timestamp)

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ—à–ª–∞ –ª–∏ –Ω–µ–¥–µ–ª—è —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
          const weekInMs = 7 * 24 * 60 * 60 * 1000
          if (today.getTime() - savedDate.getTime() > weekInMs) {
            localStorage.removeItem('fridayState')
            return null
          }

          return state
        } catch (e) {
          localStorage.removeItem('fridayState')
          return null
        }
      }
      document.addEventListener('DOMContentLoaded', function () {
        const nameInput = document.getElementById('userName')
        const dateInput = document.getElementById('workDate')

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏
        const savedName = localStorage.getItem('userName')
        if (savedName) nameInput.value = savedName

        // –õ–æ–≥–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞—Ç—ã
        const isFriday = isFridayToday()

        if (isFriday) {
          // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –ø—è—Ç–Ω–∏—Ü–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          const fridayState = loadFridayState()

          if (fridayState && fridayState.isFriday) {
            // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞ –≤—á–µ—Ä–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
            dateInput.value = getTodayDate()
          } else {
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –ø—è—Ç–Ω–∏—Ü—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
            const yesterday = new Date()
            yesterday.setDate(yesterday.getDate() - 1)
            dateInput.value = yesterday.toISOString().split('T')[0]
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ –ø—è—Ç–Ω–∏—Ü–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
          const yesterday = new Date()
          yesterday.setDate(yesterday.getDate() - 1)
          dateInput.value = yesterday.toISOString().split('T')[0]
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        nameInput.addEventListener('input', saveUserNameToLocalStorage)
      })

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      window.addEventListener('DOMContentLoaded', () => {
        if (projects.length === 0) addProject()
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(updateTimePlaceholders, 100)
      })
    </script>
  </body>
</html>
